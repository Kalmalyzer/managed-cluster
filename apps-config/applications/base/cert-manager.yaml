# Application entry for cert-manager

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  creationTimestamp: null
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    app.kubernetes.io/name: cert-manager
  name: cert-manager
  namespace: argocd
spec:
  # Deploy the application to specified cluster/namespace
  # OVERRIDE PER-ENVIRONMENT
  destination:
    name: <cluster name>
    namespace: cert-manager

  # Ignore these differences between live and desired states during the diff. Note that these configurations are not
  # used during the sync process unless the `RespectIgnoreDifferences=true` sync option is enabled.
  ignoreDifferences:
    - group: argoproj.io
      jsonPointers:
        - /status
      kind: Application

  # The Project which this Application belongs to
  project: cert-manager

  # Fetch resources for the Application from this Git repo
  # OVERRIDE PER-ENVIRONMENT
  source:
    path: k8s
    path: <app path within Git repository>
    repoURL: <Git repository URL>

  syncPolicy:
    automated:
      # Allow automated sync to delete resources, if thre are resources in the cluster but the Git repo is completely empty
      # Reference: https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automatic-pruning-with-allow-empty-v18
      allowEmpty: true

      # Allow automated sync to delete resources, if they exist in the cluster but not in the Git repo
      # Reference: https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automatic-pruning
      prune: true

      # Allow automated syncs to be triggered by changes to the live cluster (this makes the application self-healing)
      # Reference: https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automatic-self-healing
      selfHeal: true

    # Set these labels/annotations on the application namespace
    # Reference: https://argo-cd.readthedocs.io/en/stable/user-guide/sync-options/#namespace-metadata
    managedNamespaceMetadata:
      labels:
        # Allow HTTPRoutes in this namespace to attach to the 'apps' shared gateway in the 'cluster-resources' namespace
        shared-gateway-access: "true"

    syncOptions:
      # Create/destroy the namespace referenced in spec.destination.namespace along with the Application
      #   and apply labels/annotations from spec.syncPolicy.managedNamespaceMetadata to the namespace
      - CreateNamespace=true
